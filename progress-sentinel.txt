# Progress Log - Sentinel

## Learnings
(Patterns discovered during implementation)

## Key Files Reference
- Config: `sentinel/sentinel_config.json`
- Monitor: `sentinel/sentinel_monitor.sh`
- Orchestrator: `sentinel/sentinel.sh`
- Claude Prompt: `sentinel/sentinel_diagnose.md`
- Telegram Handler: `bot/telegram_handler.py`
- Skill: `.claude/commands/auto-manage.md`

## VPS Access Pattern
```bash
ssh -i ~/.ssh/polymarket_vultr root@216.238.85.11 "command"
```

## State File Locations (VPS)
- Primary: /opt/polymarket-autotrader/state/intra_epoch_state.json
- Fallback: /opt/polymarket-autotrader/state/trading_state.json

---

## Iteration 1 - US-001: Create Sentinel directory structure and configuration
- Created sentinel/ directory with events/, history/, state/ subdirectories
- Created sentinel_config.json with all required settings
- Initialized events/queue.json as empty array []
- Created empty history/actions.log
- Added state/.gitkeep for gitignored runtime state
- Updated .gitignore to exclude sentinel/state/
- Files changed: .gitignore, sentinel/sentinel_config.json, sentinel/events/queue.json, sentinel/history/actions.log, sentinel/state/.gitkeep
- Learnings for future iterations:
  - Config file structure is flat with nested objects for each concern (polling, safety, vps, etc.)
  - Empty files need to be created explicitly (.gitkeep, actions.log)
  - JSON validation with `python3 -m json.tool` is useful for verification
---

## Iteration 2 - US-002: Create sentinel_monitor.sh polling daemon
- Created sentinel/sentinel_monitor.sh with start/stop/status commands
- Implements polling loop that SSHs to VPS and reads state files
- Detects halt transitions (mode changed TO "halted") and adds events to queue
- Supports kill switch file to pause processing
- Logs to state/monitor.log with timestamps
- Files changed: sentinel/sentinel_monitor.sh, PRD-sentinel.md
- Learnings for future iterations:
  - Use `jq` for JSON parsing in bash, available on Mac by default
  - SSH command uses `-o ConnectTimeout` and `-o BatchMode=yes` for non-interactive operation
  - The `stat` command differs between Mac and Linux (use `stat -f` on Mac)
  - PID file management pattern: write PID to file on start, check with `kill -0` for existence, remove on stop
  - Events queue is JSON array in events/queue.json, append with jq
---

## Iteration 3 - US-003: Create sentinel_diagnose.md Claude prompt template
- Created sentinel/sentinel_diagnose.md with comprehensive diagnostic prompt
- Includes all required sections: Context, Decision Types, Available Actions, Decision Criteria, Output Format
- Has 4 detailed examples covering: stale peak balance (auto-fix), low balance (escalate), manual halt (escalate), loss streak recovery (auto-fix)
- Clear rules: balance < $50 = escalate, manual halt = escalate, confidence < 70% = escalate
- JSON output format includes decision, action, reason, confidence, and analysis object
- Files changed: sentinel/sentinel_diagnose.md, PRD-sentinel.md
- Learnings for future iterations:
  - Prompt template serves as the "brain" of Sentinel - Claude uses this to make decisions
  - Examples are critical for consistent behavior - include both auto-fix and escalate cases
  - The analysis object in output helps with debugging and audit trail
  - Always include "when in doubt, escalate" guidance to err on side of safety
---

## Iteration 4 - US-004: Create sentinel.sh main orchestrator
- Created sentinel/sentinel.sh with ~380 lines of bash code
- Core functions implemented:
  - `load_config()` - Reads all settings from sentinel_config.json
  - `get_vps_state()` - SSH to VPS and read state file (with fallback)
  - `get_recent_logs()` - SSH to VPS and tail bot log
  - `get_onchain_balance()` - Query Polygon RPC for USDC balance
  - `gather_diagnostics()` - Combines event info, VPS state, on-chain balance, recent logs
  - `invoke_claude_diagnosis()` - Runs `claude --dangerously-skip-permissions -p` with prompt
  - `parse_decision()` - Extracts JSON block from Claude output
  - `process_event()` - Main event processing logic with safety checks
  - `check_kill_switch()`, `check_rate_limit()` - Safety guardrails
  - `acquire_lock()`, `release_lock()` - Prevent concurrent execution
- Supports --dry-run flag for testing without executing actions
- Lock file mechanism ensures only one sentinel.sh runs at a time
- Rate limiting stored in state/rate_limit.json (resets hourly)
- Files changed: sentinel/sentinel.sh, PRD-sentinel.md
- Learnings for future iterations:
  - Use `jq -c` to output JSON on single line for piping to while loops
  - Bash here-doc trick: `$(echo "$prompt" | claude ...)` works better than echo piping
  - Lock file pattern: check if PID still running with `kill -0 $pid 2>/dev/null`
  - Parse JSON from Claude output by looking for ```json...``` blocks first
  - Balance floor check should happen BEFORE Claude invocation to save time/cost
  - Actual fix execution (US-008) is stubbed - currently just logs "approved" status
---

## Iteration 5 - US-005: Implement Telegram notification for halt events
- Added two new functions to sentinel/sentinel.sh:
  - `send_telegram_notification()` - Generic function to send Telegram messages via VPS
  - `send_halt_alert()` - Formats and sends the halt alert with all required info
- Message format includes:
  - ðŸš¨ SENTINEL ALERT header
  - Halt reason and timestamp
  - Financial status (balance, peak, drawdown %)
  - Claude's analysis summary
  - Recommended action with confidence
  - Response options (/approve, /deny, /custom)
  - Timeout warning (15 min by default)
- Uses existing `bot/telegram_handler.py` via SSH to VPS
- `send_message_sync()` called for synchronous delivery confirmation
- Telegram notification sent in `process_event()` after Claude diagnosis, before action
- Dry-run mode skips Telegram notifications
- Files changed: sentinel/sentinel.sh, PRD-sentinel.md
- Learnings for future iterations:
  - SSH + Python one-liner pattern works well: `ssh VPS "python3 -c \"...\""`
  - Message escaping is critical: escape backslashes and quotes for Python strings
  - `bot.send_message_sync()` returns True/False for success/failure
  - HTML parse_mode with <b>, <code> tags provides good formatting
  - Triple quotes in bash heredocs need careful escaping
  - Telegram is already enabled on VPS with token and chat_id configured
---

## Iteration 6 - US-006: Add get_recent_commands method to telegram_handler.py
- Added `get_recent_commands(self, since_minutes: int = 5) -> list[str]` method to TelegramBot class
- Method implementation:
  - Calls getUpdates API with offset=-10 to get recent messages without changing polling offset
  - Filters to authorized user only (via `is_authorized()`)
  - Filters by time window using message timestamp vs cutoff
  - Only returns messages that start with "/" (commands)
  - Returns full command text (e.g., "/approve", "/deny reason")
  - Graceful error handling: returns empty list on any failure
- Added imports: `datetime`, `timedelta`, `timezone` from datetime module
- Files changed: bot/telegram_handler.py, PRD-sentinel.md
- Learnings for future iterations:
  - Use `offset=-10` in getUpdates to fetch recent without modifying main polling offset
  - Telegram message `date` field is Unix timestamp (needs `datetime.fromtimestamp()`)
  - Always use timezone-aware datetime for comparisons (timezone.utc)
  - Type hint `list[str]` requires Python 3.9+ (this codebase uses 3.11+)
  - Pre-existing mypy error on line 287 is unrelated Optional[float] issue (not blocking)
---

## Iteration 7 - US-007: Implement Telegram response polling in sentinel.sh
- Added `TELEGRAM_POLL_INTERVAL=10` configuration variable
- Implemented `poll_telegram_commands()` function:
  - Calls TelegramBot.get_recent_commands() via SSH to VPS
  - Returns most recent command string
- Implemented `wait_for_telegram_response()` function:
  - Polls every 10 seconds (configurable) for up to 15 minutes
  - Tracks initial commands to detect new ones
  - Recognizes /approve, /deny, /deny <reason>, /custom <action>, /halt
  - Returns "approve", "deny", "custom <action>", or "timeout"
  - Logs progress every minute while waiting
- Implemented `send_action_confirmation()` function:
  - Formats confirmation message with emoji and header
  - Includes action, result, timestamp
  - Adds "/halt to stop if needed" for auto-fixes
- Updated `process_event()` to use polling:
  - Sends Telegram alert, then waits for response
  - On approve: checks rate limit, executes action (stub), sends confirmation
  - On deny: logs denial, leaves bot halted, sends confirmation
  - On custom: validates action against allowed list, executes if valid
  - On timeout: checks confidence >= 70% and rate limit before auto-fix
  - Sends notification when auto-fix blocked due to low confidence or rate limit
- Dry-run mode skips notification and polling entirely
- Files changed: sentinel/sentinel.sh, PRD-sentinel.md
- Learnings for future iterations:
  - Pattern for polling: track initial state, compare on each poll to detect changes
  - Telegram command parsing needs case normalization (tr '[:upper:]' '[:lower:]')
  - Use xargs for trimming whitespace from command strings
  - Allowed actions list for /custom validation: reset_peak_balance, resume_trading, reset_loss_streak, restart_bot
  - Actual execution is stubbed - US-008 will implement the real fix functions
  - Progress logging (every minute) helps user know the script is still running
---
