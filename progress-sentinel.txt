# Progress Log - Sentinel

## Learnings
(Patterns discovered during implementation)

## Key Files Reference
- Config: `sentinel/sentinel_config.json`
- Monitor: `sentinel/sentinel_monitor.sh`
- Orchestrator: `sentinel/sentinel.sh`
- Claude Prompt: `sentinel/sentinel_diagnose.md`
- Telegram Handler: `bot/telegram_handler.py`
- Skill: `.claude/commands/auto-manage.md`

## VPS Access Pattern
```bash
ssh -i ~/.ssh/polymarket_vultr root@216.238.85.11 "command"
```

## State File Locations (VPS)
- Primary: /opt/polymarket-autotrader/state/intra_epoch_state.json
- Fallback: /opt/polymarket-autotrader/state/trading_state.json

---

## Iteration 1 - US-001: Create Sentinel directory structure and configuration
- Created sentinel/ directory with events/, history/, state/ subdirectories
- Created sentinel_config.json with all required settings
- Initialized events/queue.json as empty array []
- Created empty history/actions.log
- Added state/.gitkeep for gitignored runtime state
- Updated .gitignore to exclude sentinel/state/
- Files changed: .gitignore, sentinel/sentinel_config.json, sentinel/events/queue.json, sentinel/history/actions.log, sentinel/state/.gitkeep
- Learnings for future iterations:
  - Config file structure is flat with nested objects for each concern (polling, safety, vps, etc.)
  - Empty files need to be created explicitly (.gitkeep, actions.log)
  - JSON validation with `python3 -m json.tool` is useful for verification
---

## Iteration 2 - US-002: Create sentinel_monitor.sh polling daemon
- Created sentinel/sentinel_monitor.sh with start/stop/status commands
- Implements polling loop that SSHs to VPS and reads state files
- Detects halt transitions (mode changed TO "halted") and adds events to queue
- Supports kill switch file to pause processing
- Logs to state/monitor.log with timestamps
- Files changed: sentinel/sentinel_monitor.sh, PRD-sentinel.md
- Learnings for future iterations:
  - Use `jq` for JSON parsing in bash, available on Mac by default
  - SSH command uses `-o ConnectTimeout` and `-o BatchMode=yes` for non-interactive operation
  - The `stat` command differs between Mac and Linux (use `stat -f` on Mac)
  - PID file management pattern: write PID to file on start, check with `kill -0` for existence, remove on stop
  - Events queue is JSON array in events/queue.json, append with jq
---

## Iteration 3 - US-003: Create sentinel_diagnose.md Claude prompt template
- Created sentinel/sentinel_diagnose.md with comprehensive diagnostic prompt
- Includes all required sections: Context, Decision Types, Available Actions, Decision Criteria, Output Format
- Has 4 detailed examples covering: stale peak balance (auto-fix), low balance (escalate), manual halt (escalate), loss streak recovery (auto-fix)
- Clear rules: balance < $50 = escalate, manual halt = escalate, confidence < 70% = escalate
- JSON output format includes decision, action, reason, confidence, and analysis object
- Files changed: sentinel/sentinel_diagnose.md, PRD-sentinel.md
- Learnings for future iterations:
  - Prompt template serves as the "brain" of Sentinel - Claude uses this to make decisions
  - Examples are critical for consistent behavior - include both auto-fix and escalate cases
  - The analysis object in output helps with debugging and audit trail
  - Always include "when in doubt, escalate" guidance to err on side of safety
---

## Iteration 4 - US-004: Create sentinel.sh main orchestrator
- Created sentinel/sentinel.sh with ~380 lines of bash code
- Core functions implemented:
  - `load_config()` - Reads all settings from sentinel_config.json
  - `get_vps_state()` - SSH to VPS and read state file (with fallback)
  - `get_recent_logs()` - SSH to VPS and tail bot log
  - `get_onchain_balance()` - Query Polygon RPC for USDC balance
  - `gather_diagnostics()` - Combines event info, VPS state, on-chain balance, recent logs
  - `invoke_claude_diagnosis()` - Runs `claude --dangerously-skip-permissions -p` with prompt
  - `parse_decision()` - Extracts JSON block from Claude output
  - `process_event()` - Main event processing logic with safety checks
  - `check_kill_switch()`, `check_rate_limit()` - Safety guardrails
  - `acquire_lock()`, `release_lock()` - Prevent concurrent execution
- Supports --dry-run flag for testing without executing actions
- Lock file mechanism ensures only one sentinel.sh runs at a time
- Rate limiting stored in state/rate_limit.json (resets hourly)
- Files changed: sentinel/sentinel.sh, PRD-sentinel.md
- Learnings for future iterations:
  - Use `jq -c` to output JSON on single line for piping to while loops
  - Bash here-doc trick: `$(echo "$prompt" | claude ...)` works better than echo piping
  - Lock file pattern: check if PID still running with `kill -0 $pid 2>/dev/null`
  - Parse JSON from Claude output by looking for ```json...``` blocks first
  - Balance floor check should happen BEFORE Claude invocation to save time/cost
  - Actual fix execution (US-008) is stubbed - currently just logs "approved" status
---

## Iteration 5 - US-005: Implement Telegram notification for halt events
- Added two new functions to sentinel/sentinel.sh:
  - `send_telegram_notification()` - Generic function to send Telegram messages via VPS
  - `send_halt_alert()` - Formats and sends the halt alert with all required info
- Message format includes:
  - ðŸš¨ SENTINEL ALERT header
  - Halt reason and timestamp
  - Financial status (balance, peak, drawdown %)
  - Claude's analysis summary
  - Recommended action with confidence
  - Response options (/approve, /deny, /custom)
  - Timeout warning (15 min by default)
- Uses existing `bot/telegram_handler.py` via SSH to VPS
- `send_message_sync()` called for synchronous delivery confirmation
- Telegram notification sent in `process_event()` after Claude diagnosis, before action
- Dry-run mode skips Telegram notifications
- Files changed: sentinel/sentinel.sh, PRD-sentinel.md
- Learnings for future iterations:
  - SSH + Python one-liner pattern works well: `ssh VPS "python3 -c \"...\""`
  - Message escaping is critical: escape backslashes and quotes for Python strings
  - `bot.send_message_sync()` returns True/False for success/failure
  - HTML parse_mode with <b>, <code> tags provides good formatting
  - Triple quotes in bash heredocs need careful escaping
  - Telegram is already enabled on VPS with token and chat_id configured
---

## Iteration 6 - US-006: Add get_recent_commands method to telegram_handler.py
- Added `get_recent_commands(self, since_minutes: int = 5) -> list[str]` method to TelegramBot class
- Method implementation:
  - Calls getUpdates API with offset=-10 to get recent messages without changing polling offset
  - Filters to authorized user only (via `is_authorized()`)
  - Filters by time window using message timestamp vs cutoff
  - Only returns messages that start with "/" (commands)
  - Returns full command text (e.g., "/approve", "/deny reason")
  - Graceful error handling: returns empty list on any failure
- Added imports: `datetime`, `timedelta`, `timezone` from datetime module
- Files changed: bot/telegram_handler.py, PRD-sentinel.md
- Learnings for future iterations:
  - Use `offset=-10` in getUpdates to fetch recent without modifying main polling offset
  - Telegram message `date` field is Unix timestamp (needs `datetime.fromtimestamp()`)
  - Always use timezone-aware datetime for comparisons (timezone.utc)
  - Type hint `list[str]` requires Python 3.9+ (this codebase uses 3.11+)
  - Pre-existing mypy error on line 287 is unrelated Optional[float] issue (not blocking)
---

## Iteration 7 - US-007: Implement Telegram response polling in sentinel.sh
- Added `TELEGRAM_POLL_INTERVAL=10` configuration variable
- Implemented `poll_telegram_commands()` function:
  - Calls TelegramBot.get_recent_commands() via SSH to VPS
  - Returns most recent command string
- Implemented `wait_for_telegram_response()` function:
  - Polls every 10 seconds (configurable) for up to 15 minutes
  - Tracks initial commands to detect new ones
  - Recognizes /approve, /deny, /deny <reason>, /custom <action>, /halt
  - Returns "approve", "deny", "custom <action>", or "timeout"
  - Logs progress every minute while waiting
- Implemented `send_action_confirmation()` function:
  - Formats confirmation message with emoji and header
  - Includes action, result, timestamp
  - Adds "/halt to stop if needed" for auto-fixes
- Updated `process_event()` to use polling:
  - Sends Telegram alert, then waits for response
  - On approve: checks rate limit, executes action (stub), sends confirmation
  - On deny: logs denial, leaves bot halted, sends confirmation
  - On custom: validates action against allowed list, executes if valid
  - On timeout: checks confidence >= 70% and rate limit before auto-fix
  - Sends notification when auto-fix blocked due to low confidence or rate limit
- Dry-run mode skips notification and polling entirely
- Files changed: sentinel/sentinel.sh, PRD-sentinel.md
- Learnings for future iterations:
  - Pattern for polling: track initial state, compare on each poll to detect changes
  - Telegram command parsing needs case normalization (tr '[:upper:]' '[:lower:]')
  - Use xargs for trimming whitespace from command strings
  - Allowed actions list for /custom validation: reset_peak_balance, resume_trading, reset_loss_streak, restart_bot
  - Actual execution is stubbed - US-008 will implement the real fix functions
  - Progress logging (every minute) helps user know the script is still running
---

## Iteration 8 - US-008: Implement auto-fix execution functions
- Implemented `execute_fix()` function in sentinel.sh (~180 lines)
- Four fix actions supported:
  - `reset_peak_balance`: Updates state files with peak_balance = current_balance, mode = "normal", clears halt_reason
  - `resume_trading`: Updates state files with mode = "normal", clears halt_reason
  - `reset_loss_streak`: Updates state files with consecutive_losses = 0, mode = "normal", clears halt_reason
  - `restart_bot`: Runs `systemctl restart polymarket-bot`, verifies status is "active"
- Each state file fix uses Python for atomic read-modify-write
- All four state file fixes update both `intra_epoch_state.json` and `trading_state.json`
- Function returns 0 on success with descriptive message, 1 on failure
- Results are logged to history via log_action() with details
- Updated three locations in process_event() to call execute_fix():
  - User approved action flow
  - Custom action flow
  - Timeout auto-fix flow
- Each flow now checks fix_exit_code and sends appropriate confirmation
- Files changed: sentinel/sentinel.sh, PRD-sentinel.md
- Learnings for future iterations:
  - Use Python for complex JSON manipulation over jq (easier read-modify-write atomicity)
  - SSH + python one-liner with triple-quoted f-strings handles multi-file updates well
  - Always verify systemctl status after restart with short delay (sleep 2)
  - Include both old and new values in status messages for audit trail
  - Handle "none" and empty action strings gracefully (no-op with success)
---

## Iteration 9 - US-009: Implement consecutive fix loop detection
- Added `RECENT_FIXES_FILE="$STATE_DIR/recent_fixes.json"` variable
- Implemented three new functions in sentinel.sh:
  - `track_fix(issue_type)`: Records fix with Unix timestamp, cleans entries older than 30 min
  - `check_fix_loop(issue_type)`: Returns 0 (true) if 2+ fixes for same issue in last 30 min
  - `clear_fix_history(issue_type)`: Removes all entries for given issue type
- Integration points in `process_event()`:
  - Check for fix loop after rate limit check (before timeout auto-fix)
  - If loop detected: sends escalation message, updates status, returns early
  - Escalation message includes issue type and explains manual intervention needed
  - `track_fix()` called after successful timeout auto-fix
  - `clear_fix_history()` called on user approve, deny, and custom action success
- Uses `halt_reason` as the `issue_type` for tracking consistency
- Files changed: sentinel/sentinel.sh, PRD-sentinel.md
- Learnings for future iterations:
  - Unix timestamps (date +%s) are easier for arithmetic comparisons than ISO strings
  - jq `--argjson` for numeric values, `--arg` for strings
  - Fix loop check happens BEFORE the fix attempt to prevent unnecessary work
  - Clearing history on manual intervention prevents false positives after user confirms fix is working
  - CONSECUTIVE_FIX_LIMIT=2 is loaded from config, matches rate_limits.consecutive_fix_limit
---

## Iteration 10 - US-010: Implement configurable alert rules system
- Added default alert rules to sentinel_config.json:
  - `low_balance`: balance < 75, severity=warning, cooldown=60 min
  - `critical_balance`: balance < 30, severity=critical, cooldown=30 min
  - `high_drawdown`: drawdown_pct > 25, severity=warning, cooldown=60 min
  - `losing_streak`: consecutive_losses >= 3, severity=warning, cooldown=30 min
- Added ALERT_COOLDOWNS_FILE variable to sentinel_monitor.sh
- Implemented new functions in sentinel_monitor.sh:
  - `init_alert_cooldowns()`: Creates empty JSON file if needed
  - `check_alert_cooldown(name, minutes)`: Returns 0 if in cooldown, 1 if can trigger
  - `update_alert_cooldown(name)`: Updates timestamp for alert
  - `evaluate_condition(condition, state)`: Uses sed+bc to evaluate condition strings
  - `get_severity_emoji(severity)`: Returns â„¹ï¸/âš ï¸/ðŸš¨ based on severity
  - `send_alert_notification(name, severity, condition, state)`: Formats and sends via Telegram
  - `evaluate_alerts(state)`: Main loop that evaluates all alert rules
- Integrated `evaluate_alerts()` call into poll_loop() after halt transition check
- Alert messages include severity, condition, timestamp, and current state values
- Files changed: sentinel/sentinel_config.json, sentinel/sentinel_monitor.sh, PRD-sentinel.md
- Learnings for future iterations:
  - Condition evaluation with sed substitution + bc works for simple expressions
  - Cooldowns use Unix timestamps stored in JSON for easy comparison
  - Alert rules are defined as JSON objects in config with name, condition, severity, cooldown_minutes
  - jq `--arg` for string vars, `--argjson` for numeric values (timestamps)
  - Each alert has independent cooldown tracking to prevent spam
---

## Iteration 11 - US-011: Create /auto-manage skill definition
- Rewrote `.claude/commands/auto-manage.md` to interface with Sentinel system (was referencing old event_orchestrator.py)
- Default behavior (no args): Manual diagnostic with SSH commands to gather VPS state, logs, balance
- Implemented all 5 subcommands:
  - `status`: Check monitor PID, show last state, pending events, rate limit usage
  - `start`: Run sentinel_monitor.sh start
  - `stop`: Run sentinel_monitor.sh stop
  - `history`: tail -20 history/actions.log
  - `config`: Display sentinel_config.json formatted
- Comprehensive safety section:
  - Kill switch location and commands
  - Rate limits table with all values
  - Fix loop detection explanation
  - Allowed vs prohibited actions list
- Added architecture diagram, file locations table, troubleshooting guide, and examples
- Files changed: .claude/commands/auto-manage.md, PRD-sentinel.md
- Learnings for future iterations:
  - Skill files are markdown prompts that Claude follows (not executable code)
  - Skills should provide executable bash snippets for Claude to run
  - The "Execute:" pattern with code blocks guides Claude on what commands to run
  - Including example outputs helps users understand expected behavior
  - Safety information should be prominent and easily findable
---

## Iteration 12 - US-012: Implement /auto-manage skill execution logic
- Added "Argument Parsing" section at top of auto-manage.md with explicit routing rules
- Routing logic: empty/no args â†’ diagnostic, status/start/stop/history/config â†’ subcommand
- All subcommands verified working:
  - status: Shows monitor PID status, last state JSON, pending events count, rate limit usage
  - start: Calls sentinel_monitor.sh start with verify step
  - stop: Calls sentinel_monitor.sh stop with verify step
  - history: Shows last 20 lines from history/actions.log
  - config: Displays sentinel_config.json with python3 -m json.tool formatting
- Default diagnostic gathers VPS state, recent logs, on-chain balance via SSH
- Files changed: .claude/commands/auto-manage.md, PRD-sentinel.md
- Learnings for future iterations:
  - Skill files need explicit argument parsing section for Claude to route correctly
  - The numbered list format (1. If X â†’ Do Y) is clear for routing logic
  - Testing each subcommand manually verifies the bash snippets work
  - Skills that call external scripts (sentinel_monitor.sh) should include verify steps
  - Unknown subcommand handling improves user experience
---

## Iteration 13 - US-013: Add auto-fix notification with undo option
- Enhanced `send_action_confirmation()` function to accept optional reason and confidence parameters
- Modified message format for `timeout_auto_fix` trigger to include:
  - Reason (Claude's analysis summary)
  - Confidence level (percentage)
  - "Reply /halt to stop if needed" already present
- Updated auto-fix call sites to pass reason and confidence
- Updated log_action calls to include "timeout_auto_fix:" prefix for audit trail
- Files changed: sentinel/sentinel.sh, PRD-sentinel.md
- Learnings for future iterations:
  - Bash function parameters with defaults: `local var="${N:-}"`
  - Message formatting with conditional sections: check `-n "$var"` before adding
  - Auto-fix notifications benefit from context (reason+confidence) so user can verify decision was sensible
  - Undo option (/halt) is important for user control after automated actions
---

## Iteration 14 - US-014: Add comprehensive error handling to sentinel scripts
- Added `log_error()` function to both scripts with stack trace logging to `state/error.log`
- Added `send_critical_error_notification()` function to both scripts for Telegram alerts
- Updated `get_vps_state()` in both scripts:
  - Added retry logic (3 retries with exponential backoff)
  - Added SSH failure counter tracking (MAX_SSH_FAILURES=5)
  - Detects and logs malformed JSON in state files
  - Sends critical notification when too many consecutive SSH failures
- Updated `send_telegram_notification()` and `send_alert_notification()`:
  - Added 3 retry attempts with exponential backoff
  - Logs errors after all retries fail
- Updated `invoke_claude_diagnosis()`:
  - Captures Claude exit code and output
  - Sends critical notification on failure
  - Escalates to user automatically
- Updated `parse_decision()` to log malformed JSON details to error.log
- Added `set -e` to sentinel.sh with trap for cleanup
- Added `cleanup()` function with proper lock release
- Updated main() to handle errors gracefully in event processing loop
- Added heartbeat writing (`write_heartbeat()`) to monitor poll loop
- Files changed: sentinel/sentinel_monitor.sh, sentinel/sentinel.sh, PRD-sentinel.md
- Learnings for future iterations:
  - Use `caller $frame` in bash to get stack trace for error logging
  - SSH options `-o ServerAliveInterval=5 -o ServerAliveCountMax=2` help detect connection issues
  - Pattern for retry with exponential backoff: `retry_delay=$((retry_delay * 2))`
  - Use `set +e` temporarily when you want to handle errors gracefully rather than exit
  - Trap cleanup function should handle case where lock doesn't exist: `release_lock 2>/dev/null || true`
  - Global counters (SSH_FAILURE_COUNT) useful for tracking repeated failures across poll cycles
  - Error log with stack trace helps debugging issues when running as daemon
---

## Iteration 15 - US-015: Add monitor health check and self-recovery
- Added `health` subcommand to sentinel_monitor.sh
- Implemented health check functions:
  - `check_heartbeat()`: Verifies heartbeat is within last 2 minutes (HEARTBEAT_MAX_AGE_SECONDS=120)
  - `check_pid_health()`: Verifies PID file exists and process is running
  - `check_ssh_health()`: Counts SSH failures from error.log in last 10 minutes
- Implemented self-recovery:
  - `attempt_self_recovery()`: Stops old process (with force kill fallback), starts fresh, waits for heartbeat
  - Waits up to 10 seconds for first heartbeat after restart to confirm success
- Implemented `send_recovery_failure_notification()` for Telegram alerts on failed recovery
- `cmd_health()` orchestrates: runs all checks, counts issues, triggers recovery if unhealthy
- Updated usage header and main() case statement for new `health` command
- Files changed: sentinel/sentinel_monitor.sh, PRD-sentinel.md
- Learnings for future iterations:
  - Mac uses `date -v-10M +%s` for relative time; Linux uses `date -d '10 minutes ago' +%s`
  - Mac uses `date -j -f "%Y-%m-%d %H:%M:%S"` for parsing; Linux uses `date -d`
  - Use `perl -e 'alarm(5); exec @ARGV'` as cross-platform timeout on Mac (no `timeout` command)
  - Heartbeat pattern: write Unix timestamp, check age < MAX_AGE_SECONDS
  - Self-recovery should clear heartbeat file to ensure fresh write after restart
  - Wait for heartbeat with loop + sleep is better than fixed sleep (returns faster on success)
---
