# Progress Log - Bug Fixes

## Learnings
(Patterns discovered during implementation)

---

## Iteration 1 - US-BF-013: Disable ML mode temporarily
- Added USE_ML_MODEL=False flag to config/agent_config.py
- Updated bot/momentum_bot_v12.py to check config flag before environment variable
- Added startup log message: "üö´ ML mode disabled - using agent-only mode (USE_ML_MODEL=False)"
- Files changed:
  - config/agent_config.py (added USE_ML_MODEL flag)
  - bot/momentum_bot_v12.py (updated ML check logic and added startup logging)
- Learnings for future iterations:
  - Config flag takes precedence over environment variable (proper override hierarchy)
  - ML mode requires BOTH USE_ML_MODEL=True AND USE_ML_BOT=true env var
  - With USE_ML_MODEL=False, ML code path is completely skipped regardless of env var
  - Bot will now use agent-only decision making
  - Syntax checks passed for both modified files
---

## Iteration 2 - US-BF-014: Lower entry price threshold
- Added MAX_ENTRY = 0.25 global cap to config/agent_config.py
- Added EARLY_MAX_ENTRY = 0.30 to config for clarity (bot already had this value)
- Added validation in bot/momentum_bot_v12.py to enforce MAX_ENTRY before placing trades
- Files changed:
  - config/agent_config.py (added MAX_ENTRY and EARLY_MAX_ENTRY constants)
  - bot/momentum_bot_v12.py (added global entry price validation at line 2872-2881)
  - PRD.md (marked US-BF-014 complete)
  - test_entry_price.py (created test to verify entry price rejection)
- Learnings for future iterations:
  - MAX_ENTRY is enforced AFTER strategy selection but BEFORE correlation checks
  - Validation uses getattr() with default fallback for backward compatibility
  - Entry price cap reduces breakeven win rate from 52% to 51% (fee economics)
  - Test coverage: Created test_entry_price.py to verify rejection logic
  - All syntax checks passed for both modified files
---

## Iteration 3 - US-BF-015: Check and disable bull market overrides
- Added DISABLE_BULL_OVERRIDES = True flag to config/agent_config.py
- Implemented check_bull_market_overrides() function in bot/momentum_bot_v12.py
- Function checks if state/bull_market_overrides.json exists and logs appropriate warnings
- Files changed:
  - config/agent_config.py (added DISABLE_BULL_OVERRIDES flag with section and comments)
  - bot/momentum_bot_v12.py (added bull market override detection function and startup check)
  - PRD.md (marked US-BF-015 complete)
  - test_bull_overrides.py (created comprehensive test suite)
- Learnings for future iterations:
  - The bull_market_overrides.json file exists but was NOT being loaded (bot loads ralph_overrides.json instead)
  - Added preventive check to ensure overrides never accidentally get loaded
  - Startup logging provides three scenarios:
    1. File exists + disabled: WARNING with confirmation overrides ignored
    2. File exists + NOT disabled: ERROR alerting to dangerous config
    3. File doesn't exist: INFO message (normal state)
  - getattr() with default value ensures backward compatibility
  - Test coverage validates flag existence, file detection, and expected behavior
  - All syntax checks and tests passed
---

## Iteration 4 - US-BF-011: Raise confluence threshold
- Changed TECH_CONFLUENCE_THRESHOLD from 0.0015 to 0.003 in config/agent_config.py (0.15% ‚Üí 0.30%)
- Updated hardcoded CONFLUENCE_THRESHOLD in agents/tech_agent.py to match
- Added explanatory comment about filtering random walk noise (¬±0.05% typical in 15min epochs)
- Files changed:
  - config/agent_config.py (line 87-88: raised threshold and added comment)
  - agents/tech_agent.py (line 26-27: raised threshold and added comment)
  - PRD.md (marked US-BF-011 complete)
  - test_confluence_threshold.py (created comprehensive test suite)
- Learnings for future iterations:
  - TechAgent has its own hardcoded CONFLUENCE_THRESHOLD (not imported from config)
  - Both locations need updating: config/agent_config.py AND agents/tech_agent.py
  - Threshold used in decision logic at lines 226 and 229 (if change > THRESHOLD)
  - 0.30% threshold filters typical random walk noise (0.05-0.25% moves)
  - Higher threshold = fewer but higher quality signals
  - Tests verify: 0.20% move filtered out, 0.35% move triggers confluence
  - All typechecks passed for both modified files
---

## Iteration 5 - US-BF-005: Implement "Skip" vote type
- Added "Skip" as fourth valid direction in agents/base_agent.py Vote dataclass
- Updated Vote.__post_init__() validation to accept "Skip" alongside Up/Down/Neutral
- Added comprehensive docstring explaining when to use each direction type
- Skip votes use confidence=0.0 and quality=0.0 by convention
- Files changed:
  - agents/base_agent.py (line 18-51: added Skip direction, updated validation, added docstring)
  - PRD.md (marked US-BF-005 complete)
  - test_skip_vote.py (created comprehensive test suite)
- Learnings for future iterations:
  - Vote dataclass accepts four directions: "Up", "Down", "Neutral", "Skip"
  - Skip prevents default-to-direction bias when agents are uncertain
  - Skip votes return 0.0 weighted score (confidence √ó quality √ó weight = 0)
  - Convention: Use Skip with confidence=0.0 and quality=0.0
  - All four directions pass validation correctly
  - Invalid directions (e.g., "Maybe") still properly rejected
  - Tests verify Skip vote creation, validation, and weighted scoring
  - Typecheck passed for base_agent.py
---
## Iteration 6 - US-BF-001: Remove TechAgent default-to-Up bias
- Changed agents/tech_agent.py line 317-329 to return Skip vote on tie/flat market
- Previous behavior: defaulted to "Up" when avg_change >= 0 (line 318)
- New behavior: returns Skip vote with confidence=0.0, quality=0.0 when tie detected
- Files changed:
  - agents/tech_agent.py (line 305-343: added Skip vote return on tie scenario)
  - test_tech_agent_skip.py (created comprehensive test suite)
  - PRD.md (marked US-BF-001 complete)
- Learnings for future iterations:
  - TechAgent has analyze() method (not vote()) - consistent with base class pattern
  - Tie detection: up_count == down_count (equal exchange signals)
  - Skip vote reasoning should be descriptive: "No confluence detected: XUp/YDown tie, avg Z% ‚Üí ABSTAINING"
  - Majority cases (3 Up/1 Down or 1 Up/3 Down) still return directional votes
  - Confluence path (when direction is not None) is unchanged - high confidence votes work as before
  - All 5 test cases passed: tie scenario, flat market, majority up, majority down, confluence
  - Typecheck passed for tech_agent.py
---
## Iteration 7 - US-BF-002: Remove SentimentAgent default-to-Up bias
- Changed agents/sentiment_agent.py line 75-83 to return Skip vote on missing orderbook
- Changed agents/sentiment_agent.py line 100-117 to return Skip vote when no contrarian signal
- Skip votes use confidence=0.0 and quality=0.0 by convention
- Files changed:
  - agents/sentiment_agent.py (two locations: missing orderbook and no contrarian signal)
  - test_sentiment_agent_skip.py (created comprehensive test suite with 5 test cases)
  - PRD.md (marked US-BF-002 complete)
- Learnings for future iterations:
  - SentimentAgent has two default-to-Up paths: missing orderbook AND no contrarian signal
  - Missing orderbook path was line 74-83 (no data available)
  - No contrarian signal path was line 100-121 (data available but no extreme prices/wrong time window)
  - Previous behavior picked cheaper side when no contrarian signal (still biased)
  - New behavior: Skip when uncertain ‚Üí prevents systematic bias
  - Contrarian path (lines 119+) unchanged - still returns directional votes with high confidence
  - Test coverage: 5 scenarios (no orderbook, no contrarian, no extreme prices, contrarian Down, contrarian Up)
  - All 5 tests passed, typecheck passed
---
## Iteration 8 - US-BF-003: Remove RegimeAgent default-to-Up bias
- Changed agents/regime_agent.py lines 115-147 to return Skip vote in sideways regime
- Previous behavior: Defaulted to "Up" when in sideways regime (line 127-128)
- New behavior: Returns Skip vote with confidence=0.0, quality=0.0 when sideways regime detected
- Key change: Check regime FIRST (line 117), then only pick direction for non-sideways regimes
- Files changed:
  - agents/regime_agent.py (lines 115-147: added early Skip return for sideways regime)
  - test_regime_agent_skip.py (created comprehensive test suite with 5 test cases)
  - PRD.md (marked US-BF-003 complete)
- Learnings for future iterations:
  - RegimeAgent detects overall market regime (bull_momentum, bear_momentum, volatile, sideways)
  - Sideways regime requires <75% cryptos agreeing on direction (STRONG_TREND_RATIO = 0.75)
  - RegimeAgent uses TREND_THRESHOLD = 0.001 (0.1%) to classify individual crypto trends
  - Skip vote strategy: Check regime FIRST, return Skip for sideways, then pick direction for others
  - Test data must pass correct "current prices" (ending prices), not base prices
  - _update_price_history() appends data['prices'] to history ‚Üí test data needs ending prices
  - All 5 test cases passed: sideways Skip, bull Up, bear Down, volatile detection, choppy Skip
  - Syntax check passed for regime_agent.py
---
## Iteration 9 - US-BF-004: Fix RSI neutral zone scoring
- Changed agents/tech_agent.py lines 96-97, 105-106 to return 0.5 instead of 1.0 for RSI 40-60
- Updated reasoning message to "RSI {rsi} neutral ‚Üí low confidence" (was "RSI {rsi} neutral")
- Fixed boundary conditions: Used >= 40 and <= 60 to properly include RSI=40 and RSI=60
- Files changed:
  - agents/tech_agent.py (lines 91-108: changed confidence from 1.0 to 0.5 for neutral zone)
  - test_rsi_neutral.py (created comprehensive test suite with 5 test cases)
  - PRD.md (marked US-BF-004 complete)
- Learnings for future iterations:
  - RSI neutral zone (40-60) should indicate LOW confidence, not high confidence
  - Previous behavior returned 1.0 confidence for neutral RSI ‚Üí false signals in sideways markets
  - New behavior returns 0.5 confidence for neutral RSI ‚Üí prevents false high confidence
  - Boundary conditions matter: Must use >= 40 and <= 60 to include edges (not > 40 and < 60)
  - If RSI=40 with > 40 check, falls through to else clause ‚Üí wrong confidence value
  - Test coverage: 5 scenarios (neutral zone 50, bearish 65, bullish 35, boundaries 40/60, extremes 25/75)
  - All 5 tests passed, syntax check passed
  - RSI scoring now consistent: neutral=0.5, mild signals=0.5, strong signals=0.8, opposing extremes=0.0
---
## Iteration 10 - US-BF-006: Update vote aggregator for Skip votes
- Added Skip vote filtering in coordinator/vote_aggregator.py line 119-132
- Skip votes filtered BEFORE confidence threshold filtering (proper order)
- Logs number of Skip votes and which agents abstained
- Returns empty prediction if all votes are Skip (no consensus possible)
- Updated validate_votes() to accept "Skip" as valid direction (line 301)
- Files changed:
  - coordinator/vote_aggregator.py (lines 119-132: Skip filtering, line 301: validation update)
  - test_skip_simple.py (created minimal test suite to verify filtering logic)
  - test_vote_aggregator_skip.py (created comprehensive test suite with 5 scenarios)
  - PRD.md (marked US-BF-006 complete)
- Learnings for future iterations:
  - Skip votes must be filtered FIRST, then confidence filtering on remaining votes
  - Filter order matters: Skip ‚Üí confidence ‚Üí aggregation
  - If all votes are Skip ‚Üí return empty prediction (no consensus)
  - Log info level (not warning) when Skip votes present - it's expected behavior
  - Skip vote filtering reduces vote count for consensus calculation (3 Up + 2 Down + 1 Skip = 5 votes counted)
  - Test coverage: 5 scenarios (mixed votes, all Skip, validation, mixed with low agents)
  - Syntax check passed for vote_aggregator.py
  - Logic verified with minimal test (no import errors)
---
## Iteration 11 - US-BF-007: Change weighted score to average
- Changed coordinator/vote_aggregator.py lines 154-165 to calculate average instead of sum
- Created calc_avg_weighted_score() helper function with proper formula
- Formula: weighted_score = sum(confidence * weight) / sum(weight)
- Added debug logging for weighted scores (lines 200-203)
- Files changed:
  - coordinator/vote_aggregator.py (changed sum to average, added helper function and debug logging)
  - test_weighted_average_simple.py (created comprehensive test suite with 5 test cases)
  - PRD.md (marked US-BF-007 complete)
- Learnings for future iterations:
  - Previous behavior: sum(confidence √ó quality √ó weight) ‚Üí three 0.35 votes summed to 1.05
  - New behavior: average(confidence √ó quality √ó weight) ‚Üí three 0.35 votes average to 0.12
  - Prevents weak signal stacking: multiple weak votes no longer combine into false strong signals
  - Helper function handles edge cases: empty list returns 0.0, single vote returns its own score
  - Different agent weights handled correctly: weighted average formula divides by sum of weights
  - Debug logging shows all three directional scores (Up/Down/Neutral) at DEBUG level
  - All 5 test cases passed: three weak votes, mixed confidence, different weights, single vote, empty list
  - Typecheck passed for vote_aggregator.py
  - This is a critical fix: prevents systematic bias from multiple uncertain agents voting same direction
---
## Iteration 12 - US-BF-008: Add directional balance tracker class
- Created DirectionalBalanceTracker class in coordinator/decision_engine.py
- Added DirectionalDecision dataclass to store direction + timestamp
- Uses collections.deque with maxlen for efficient rolling window (O(1) append)
- Tracks last 20 decisions (configurable window_size parameter)
- Files changed:
  - coordinator/decision_engine.py (lines 11, 26-156: added tracker class and dataclass)
  - test_balance_tracker_standalone.py (created comprehensive test suite with 6 test cases)
  - PRD.md (marked US-BF-008 complete)
- Learnings for future iterations:
  - DirectionalBalanceTracker uses deque(maxlen=N) for automatic rolling window management
  - Only Up/Down decisions tracked (Skip/Neutral ignored) - prevents false bias from abstentions
  - Bias detection requires BOTH conditions: total >= window_size AND percentage >= threshold
  - has_bias() returns False if insufficient decisions (<20) to avoid false alarms
  - get_balance_summary() provides human-readable output with emoji alert when bias detected
  - Test coverage: bias detected (15/5), balanced (10/10), empty, insufficient (<20), extreme (100%), rolling window
  - All 6 tests passed, syntax check passed
  - Class is ready for integration in next task (US-BF-009)
---
## Iteration 13 - US-BF-009: Integrate balance tracker
- Instantiated DirectionalBalanceTracker in DecisionEngine.__init__ (line 253)
- Added tracker.record() call after vote aggregation (line 323)
- Added has_bias() check and warning log when >70% bias detected (lines 326-328)
- Recording happens AFTER prediction aggregation but BEFORE trade execution checks
- Files changed:
  - coordinator/decision_engine.py (added tracker instantiation and recording logic)
  - test_balance_integration_simple.py (created comprehensive test suite with 5 tests)
  - PRD.md (marked US-BF-009 complete)
- Learnings for future iterations:
  - Balance tracker automatically filters Skip/Neutral votes (only tracks Up/Down)
  - Recording happens early in decide() method - tracks ALL decisions with direction
  - This includes decisions that don't trade (low confidence, vetoed, etc.)
  - Conditional check (if prediction.direction:) prevents errors when no direction
  - Warning logged at INFO level when bias detected (‚ö†Ô∏è emoji for visibility)
  - get_balance_summary() provides human-readable format: "Up 75% | Down 25% ‚ö†Ô∏è BIAS DETECTED"
  - Recording after aggregation ensures we only track final consensus direction (not individual votes)
  - All 5 tests passed: instantiation, record call, warning log, logic flow, conditional recording
  - Typecheck passed for decision_engine.py
  - Integration complete: Balance tracker will now alert on directional cascades (>70% same direction)
---

## Iteration 14 - US-BF-010: Verify consensus threshold
- Added startup logging to show configured thresholds in DecisionEngine.__init__ (line 256)
- Added debug logging at consensus threshold check (line 347-361)
- Logs show: "Consensus threshold check: score={score} vs threshold={threshold}"
- Added pass/fail messages with emoji indicators (‚ùå below, ‚úÖ above)
- Files changed:
  - coordinator/decision_engine.py (added startup logging and threshold check logging)
  - test_consensus_threshold.py (created comprehensive test suite with 5 tests)
  - PRD.md (marked US-BF-010 complete)
- Learnings for future iterations:
  - CONSENSUS_THRESHOLD is imported from config/agent_config.py (set to 0.75)
  - Threshold check happens at line 348: `if prediction.weighted_score < CONSENSUS_THRESHOLD`
  - Startup logging shows both thresholds: consensus and min_confidence
  - Debug logging format: "score={value:.3f} vs threshold={value:.2f}"
  - Pass/fail logged with visual indicators for easy log scanning
  - MockAgent for testing must use synchronous `def analyze()` not async
  - Vote dataclass requires agent_name parameter (not optional)
  - Test coverage: startup logging, below threshold (0.74), above threshold (0.80), exact threshold (0.75), config value verification
  - All 5 tests passed, typecheck passed
  - Debug logs now show exactly when and why consensus checks pass or fail
---
## Iteration 15 - US-BF-012: Add threshold debug logging
- Added comprehensive debug logging for all threshold checks
- Added consensus threshold logging in decision_engine.py (line 347-361)
- Added confidence threshold logging in decision_engine.py (line 364-378)
- Added confluence threshold logging in tech_agent.py (line 229-236)
- Added agent vote logging in tech_agent.py (3 return paths: Skip, weak signal, strong)
- Added agent vote logging in sentiment_agent.py (3 return paths: no orderbook, no signal, contrarian)
- Added agent vote logging in regime_agent.py (2 return paths: sideways Skip, directional)
- Files changed:
  - coordinator/decision_engine.py (added threshold check logging with emoji indicators)
  - agents/tech_agent.py (added confluence checks + vote logging for all paths)
  - agents/sentiment_agent.py (added vote logging for all 3 return paths)
  - agents/regime_agent.py (added vote logging for both return paths)
  - test_threshold_logging.py (created comprehensive test verifying all logging)
  - PRD.md (marked US-BF-012 complete)
- Learnings for future iterations:
  - Debug logging format: Use emoji indicators (‚úÖ/‚ùå) for easy log scanning
  - Logging placement: Log threshold checks BEFORE returning decision, not after
  - Consistent format: {score:.3f} for values, {threshold:.2f} for thresholds
  - Agent vote logging: Format "[{agent_name}] {crypto}: {direction} (conf={conf:.2f}) - {reasoning}"
  - Confluence logging: Log per-exchange with change % and threshold comparison
  - All logging at DEBUG level (not info/warning) - reduces noise in production logs
  - Create vote variable first, then log, then return (prevents logging code duplication)
  - Test verification: Use inspect.getsource() to verify code changes without instantiating objects
  - All 5 tests passed, typecheck passed
  - Logs will now show exactly when/why threshold checks pass or fail for diagnosis
---

