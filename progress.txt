# Polymarket AutoTrader - Progress Log

**Project Start:** January 15, 2026 16:30 UTC
**Current Phase:** ML Bot Production Stabilization
**Status:** Critical Bug Fix - Conflicting Positions

---

## Current Iteration - Emergency Stabilization (Jan 15, 2026)

**Goal:** Fix conflicting positions bug blocking ML bot profitability

**Context:**
- ML Random Forest model deployed to production
- Model shows 60% win rate (matches 67.3% test accuracy)
- Critical bug: Bot placing both Up AND Down on same crypto/epoch
- Result: Negating ML edge, causing losses despite correct predictions

**Bugs Fixed Today:**
1. ✅ ML not placing orders - Added order execution logic
2. ✅ Auto-redemption broken - Fixed epoch gating
3. ✅ Agent fallback causing conflicts - Removed guardian.add_position()
4. ✅ **FIXED:** Conflicting positions - Added live API position check

**Current Stats:**
- Balance: $176.78
- Pending: 8 positions (4 cryptos × 2 directions each = CONFLICT)
- Win Rate: 60% on resolved trades
- Loss from bugs: ~$65 today

**Next Actions:**
1. ✅ Investigate why conflicts still occurring - Root cause found
2. ✅ Add explicit position conflict check - Implemented
3. ✅ Disable agent system completely when ML enabled - Added explicit guard
4. Deploy and validate fix

---

## Iteration 1 - Fix Conflicting Positions Bug (P0)
- What was implemented:
  - Added Guardian.check_live_position_conflicts() method
  - Queries Polymarket Data API for live positions before each trade
  - Detects conflicts by crypto + direction (same OR opposite)
  - Returns detailed conflict messages for logging
  - Modified Guardian.can_open_position() to call conflict check first

- Files changed:
  - bot/momentum_bot_v12.py (lines 720-780)
    - New method: check_live_position_conflicts()
    - Updated: can_open_position() to prioritize live API check
  - test_conflict_check.py (new file for validation)

- Learnings for future iterations:
  - Guardian's internal position list (self.open_positions) was out of sync with blockchain
  - Must query live Polymarket API to get current positions
  - Position titles contain crypto name (e.g., "BTC will go up")
  - Position outcome field contains direction ("Up" or "Down")
  - Need to check for BOTH same direction AND opposite direction conflicts
  - Positions with size < 0.01 should be ignored (negligible/rounding)
  - API failures should not block trades (return False on error)
  - The agent system already skips when ML mode active (line 2240 continue)

- Gotchas encountered:
  - Cannot easily parse exact epoch timestamp from position titles
  - Using crypto + direction matching instead of epoch matching
  - This is sufficient since we only trade 15-min markets
  - API status code 400 means wallet not found or invalid params

- Useful context:
  - Polymarket Data API: https://data-api.polymarket.com/positions?user=WALLET
  - Position structure: {title, outcome, size, curPrice, conditionId, ...}
  - Guardian.can_open_position() is called at line 2178 before placing ML orders
  - The conflict check happens BEFORE correlation/limit checks (highest priority)

---

## Iteration 2 - Disable Agent System Fallback (P2)
- What was implemented:
  - Added explicit guard in agent system path to check if ML mode is active
  - Logs warning and continues if USE_ML_BOT=true and agents try to run
  - Double safety: ML path already does continue, now agents also check

- Files changed:
  - bot/momentum_bot_v12.py (line ~2250)
    - Added safety check: if use_ml_bot, skip agents completely

- Learnings for future iterations:
  - The elif structure already prevented agents when ML ran successfully
  - But if someone modifies the code flow, this guard prevents accidents
  - Explicit is better than implicit for critical safety checks
  - The use_ml_bot variable is checked at line 2041 (from env var USE_ML_BOT)

- Gotchas encountered:
  - Need to check both use_ml_bot AND ML_BOT_AVAILABLE flags
  - The ML_BOT_AVAILABLE flag is set at import time (line ~60)
  - If ML imports fail, ML_BOT_AVAILABLE=False and agents should run

---

_This is a fresh start. Previous iterations archived in progress_old.txt_
