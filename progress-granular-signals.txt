# Progress: Granular Signal Enhancement

## Iteration 1 - US-GS-001: Add Configuration Constants
- Implemented all 9 configuration constants for granular signals
- Files changed: bot/intra_epoch_bot.py, PRD-granular-signals.md
- Learnings for future iterations:
  - Constants are at lines 98-122 in a dedicated section after Telegram config
  - EXCHANGE_SYMBOLS uses Dict[str, Dict[str, str]] type hint
  - Binance uses 'XXXUSDT', Kraken uses 'XXXUSD', Coinbase uses 'XXX-USD'
  - All constants can be imported directly for testing
---

## Iteration 2 - US-GS-002: Enhance Minute Candle Fetching with Magnitude Data
- Modified fetch_minute_candles() to return list of dicts instead of strings
- Each dict contains: {"direction": "Up"/"Down", "change_pct": float, "volume": float}
- Added get_directions_from_candles() helper for backward compatibility
- Updated main loop to use candles + get_directions_from_candles() pattern
- Files changed: bot/intra_epoch_bot.py, PRD-granular-signals.md
- Learnings for future iterations:
  - fetch_minute_candles() is at line 391, returns Optional[List[Dict[str, Union[str, float]]]]
  - get_directions_from_candles() is at line 442, extracts ['Up', 'Down', ...] from candle dicts
  - Main loop at line 1115 now uses: candles = fetch_minute_candles(), minutes = get_directions_from_candles(candles)
  - Binance kline format: [open_time, open, high, low, close, volume, ...] (index 5 is volume)
  - change_pct calculation: (close - open) / open * 100
  - Added Union to typing imports for mixed-type dicts
---

## Iteration 3 - US-GS-003: Add Cumulative Magnitude Check Function
- Added check_cumulative_magnitude(candles, direction) -> Tuple[bool, float]
- Sums magnitude of candles matching the pattern direction
- Returns (passes_threshold, total_magnitude)
- Respects ENABLE_MAGNITUDE_TRACKING config (returns True, 0.0 if disabled)
- Files changed: bot/intra_epoch_bot.py, PRD-granular-signals.md
- Learnings for future iterations:
  - Function is at line 462, right after get_directions_from_candles()
  - change_pct is in percent (e.g., -0.25 for -0.25%), convert to decimal by dividing by 100
  - MIN_CUMULATIVE_MAGNITUDE = 0.008 (0.8% total move required)
  - Only candles matching direction are counted, opposite direction ignored
  - Empty list returns (False, 0.0) since 0.0 < threshold
---

## Iteration 4 - US-GS-004: Add Per-Minute Magnitude Check Function
- Added check_per_minute_magnitude(candles, direction) -> Tuple[int, int]
- Returns (strong_count, weak_count) for candles matching direction
- Strong = magnitude >= MIN_PER_MINUTE_MAGNITUDE (0.002 = 0.2%)
- If ENABLE_MAGNITUDE_TRACKING is False, all moves counted as strong
- Files changed: bot/intra_epoch_bot.py, PRD-granular-signals.md
- Learnings for future iterations:
  - Function is at line 513, right after check_cumulative_magnitude()
  - Same change_pct conversion pattern: abs(change_pct) / 100.0
  - MIN_PER_MINUTE_MAGNITUDE = 0.002 (0.2% per minute for "strong")
  - Can be used for "4 of 5 STRONG moves" filtering in pattern analysis
  - Empty list returns (0, 0) - both counts zero
---

## Iteration 5 - US-GS-005: Add Magnitude-Weighted Accuracy Boost Function
- Added calculate_magnitude_boost(candles, direction) -> float
- Returns accuracy boost from 0.0 to MAGNITUDE_ACCURACY_BOOST (0.03)
- Linear scaling: boost = (excess / threshold) * max_boost, capped at 1.0
- No boost if total magnitude <= STRONG_MOVE_THRESHOLD (0.015 = 1.5%)
- Returns 0.0 if ENABLE_MAGNITUDE_TRACKING is False
- Files changed: bot/intra_epoch_bot.py, PRD-granular-signals.md
- Learnings for future iterations:
  - Function is at line 570, right after check_per_minute_magnitude()
  - Same magnitude calculation pattern as previous functions
  - Boost formula: excess / STRONG_MOVE_THRESHOLD gives ratio 0.0-1.0
  - At exactly threshold, returns 0.0 (only boost when ABOVE threshold)
  - Example: 2.0% move gives 0.01 boost (33% of max), 3.0%+ gives full 0.03
  - mypy hangs on this file - use py_compile and unit tests for verification
---

## Iteration 6 - US-GS-006: Add Multi-Exchange Price Fetcher
- Added 4 new functions for multi-exchange price fetching
- get_binance_price(), get_kraken_price(), get_coinbase_price() - individual exchange fetchers
- fetch_multi_exchange_prices() - parallel fetcher using ThreadPoolExecutor
- Files changed: bot/intra_epoch_bot.py, PRD-granular-signals.md
- Learnings for future iterations:
  - Functions added at lines 648-792, after calculate_magnitude_boost() and before fetch_polymarket_prices()
  - Added ThreadPoolExecutor import from concurrent.futures (line 24)
  - Kraken API returns nested data: result[pair_name]['c'][0] for last trade price
  - Coinbase API returns data['amount'] under data key
  - ThreadPoolExecutor with max_workers=3 and 2s timeout per future.result()
  - Returns partial dict if some exchanges fail (graceful degradation)
  - Returns empty dict {} for invalid crypto symbols
  - EXCHANGE_SYMBOLS config at lines 114-119 maps crypto to exchange-specific symbols
---

## Iteration 7 - US-GS-007: Add Exchange Confluence Detection
- Added module-level epoch_start_prices dict to track prices at epoch start
- Added record_epoch_start_prices(crypto, epoch, prices) to store baseline prices
- Added get_exchange_confluence(crypto, epoch) -> Tuple[Optional[str], int, float]
- Returns (direction, agree_count, avg_change_pct) based on consensus
- Files changed: bot/intra_epoch_bot.py, PRD-granular-signals.md
- Learnings for future iterations:
  - Functions added at lines 795-938, new "EXCHANGE CONFLUENCE DETECTION" section after fetch_multi_exchange_prices()
  - epoch_start_prices structure: {crypto: {epoch: {exchange: price}}} for nested lookups
  - Change threshold = 0.001 (0.1%) to count as Up/Down vs Flat
  - Returns None direction when no consensus (even if some exchanges agree)
  - avg_change_pct is returned as percentage (multiplied by 100)
  - record_epoch_start_prices uses .copy() to prevent reference issues
  - get_exchange_confluence fetches fresh prices each call (no caching)
  - Uses MIN_EXCHANGES_AGREE config constant (default 2 of 3)
---

## Iteration 8 - US-GS-008: Integrate Magnitude Checks into Pattern Analysis
- Modified analyze_pattern() to accept optional candles parameter
- Integrated check_cumulative_magnitude() to reject patterns with weak magnitude (<0.8% total)
- Integrated check_per_minute_magnitude() to count strong vs weak moves
- Integrated calculate_magnitude_boost() to add accuracy boost for strong moves
- Updated reason string format: "4/5 DOWN (+2.0%) [4strong/4total] = 75.0% (+1.0% boost)"
- Updated main loop call site to pass candles to analyze_pattern()
- Files changed: bot/intra_epoch_bot.py, PRD-granular-signals.md
- Learnings for future iterations:
  - analyze_pattern() is at line 996, now accepts (minutes, candles=None)
  - Backward compatible: candles parameter is Optional with None default
  - When magnitude tracking enabled and candles provided, 3 checks happen:
    1. Cumulative magnitude check - rejects if total < MIN_CUMULATIVE_MAGNITUDE
    2. Per-minute magnitude - counts strong/weak for logging
    3. Magnitude boost - adds up to MAGNITUDE_ACCURACY_BOOST (0.03)
  - Reason string includes: direction count, magnitude %, strong count, final accuracy, boost if any
  - Main loop at line ~1684 now passes candles: analyze_pattern(minutes, candles)
  - Test cases cover: backward compat, weak rejection, strong boost, moderate no-boost, no pattern
---

## Iteration 9 - US-GS-009: Integrate Confluence as Entry Filter
- Integrated multi-exchange confluence detection into the main trading loop
- At new epoch detection (line 1640): fetch_multi_exchange_prices() for all CRYPTOS
- At new epoch detection (line 1642): record_epoch_start_prices() stores baseline
- Before placing new trade (line 1786): get_exchange_confluence() checks agreement
- Files changed: bot/intra_epoch_bot.py, PRD-granular-signals.md
- Learnings for future iterations:
  - New epoch detection block is around line 1617, after resolve_completed_positions()
  - Confluence check goes in "New position logic" section, BEFORE scan_results.append()
  - When confluence_dir matches pattern direction: log confirmation and proceed
  - When confluence_dir != pattern direction: log SKIP and continue to next crypto
  - When confluence_dir is None (no consensus): log warning but allow trade to proceed
  - scan_results updated with "(conf_mismatch)" suffix when trade skipped due to confluence
  - Test verified: live BTC prices showed 3/3 exchanges agree Down with -4.83% change
  - epoch_start_prices is module-level dict, structure: {crypto: {epoch: {exchange: price}}}
---

## Iteration 10 - US-GS-010: Add Shadow Comparison Logging
- Added log_granular_comparison() function for shadow testing comparison
- Set up separate logger "granular_signals" writing to granular_signals.log
- Logger uses propagate=False to avoid duplicate logs to main log
- Files changed: bot/intra_epoch_bot.py, PRD-granular-signals.md
- Learnings for future iterations:
  - Function is at line 963, in new "GRANULAR SIGNAL COMPARISON LOGGING" section
  - granular_log is Optional[Logger] initialized at module level (line 946)
  - Logger only created when ENABLE_GRANULAR_SHADOW_LOG is True
  - Log format: "[GRANULAR] {crypto} epoch={epoch}: Pattern=... Magnitude=... Confluence=... -> Final=..."
  - All percentages formatted with 1 decimal place for consistency
  - Function handles all edge cases: no pattern, no confluence, no boost
  - Returns early if logging disabled (no work done)
---

## Iteration 11 - US-GS-011: Update Startup Logs with Granular Settings
- Added startup log section for granular signal settings in run_bot()
- Shows magnitude tracking status and thresholds (min cumulative, per-minute, boost)
- Shows multi-exchange status and agreement requirement (2/3 exchanges)
- Shows shadow logging status (ENABLED/DISABLED)
- Uses separator lines to match existing startup log style
- Files changed: bot/intra_epoch_bot.py, PRD-granular-signals.md
- Learnings for future iterations:
  - Startup log section is at lines 1634-1651 in run_bot()
  - Uses "-" * 40 separator to visually distinguish from main settings
  - Conditional display: only shows granular section if either feature enabled
  - Format percentages as *100 with decimal places: {VAL*100:.1f}% for 0.8%
  - Matches PRD example exactly: "min cumulative 0.8%, min per-minute 0.2%, boost up to 3%"
  - py_compile used for typecheck since mypy hangs on this file
---
